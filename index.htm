<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <title>NorthPoll | Home</title>
    <link rel="shortcut icon" href="icon/favicon.ico" type="image/x-icon">
</head>
<ul>
    <li><a href="index.htm">Home</a></li>
    <li><a href="contact.htm">Contact</a></li>
    <li style="float:right;" id="buttonLogout"><a href="#logging-out">Log Out</a></li>
    <li style="float:right;" id="myProfile"><a href="profile.htm">My Profile</a></li>
</ul>

<body onload="checkRun()">
    <div class="spacer-title">
    </div>
    <hr color='#4C4B83'>
    <div class="spacer-main">
        <div id="myModal" class="modal">
            <div class="modal-content">
                <div id="piechart"></div>
            </div>
        </div>
        <center>
            <h1 style="color: #4C4B83;">Post Poll</h1>
        </center>
        <div class="container">
            <div class="group">
                <input type="text" required maxlength="60" id="txtEmail">
                <span class="highlight"></span>
                <span class="bar"></span>
                <label>Question</label>
            </div>
            <div class="group">
                <input type="text" required maxlength="20" id="op1">
                <span class="highlight"></span>
                <span class="bar"></span>
                <label>Option 1</label>
            </div>
            <div class="group">
                <input type="text" required maxlength="20" id="op2">
                <span class="highlight"></span>
                <span class="bar"></span>
                <label>Option 2</label>
            </div>
            <div class="group">
                <input type="text" required maxlength="20" id="op3">
                <span class="highlight"></span>
                <span class="bar"></span>
                <label>Option 3</label>
            </div>
            <div class="group">
                <input type="text" required maxlength="20" id="op4">
                <span class="highlight"></span>
                <span class="bar"></span>
                <label>Option 4</label>
            </div>
            <button id="buttonPost" class="buttonMain">Post</button>
        </div>
    </div>
    <hr color='#4C4B83'>

    <!--Javascript reference-->

    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="auth.js"></script>
    <script>


        let postVal;
        function AddMoreOps() {
            buttonName = 'op3'
            add = document.getElementById(buttonName);
            if (add.classList.contains('hide')) {
                add.classList.remove('hide');
            }
            else if (!add.classList.contains('hide')) {
                buttonName = 'op4';
                add = document.getElementById(buttonName);
                add.classList.remove('hide');
            }
        }

        function RemoveMoreOps() {
            buttonName = 'op4'
            add = document.getElementById(buttonName);
            if (!add.classList.contains('hide')) {
                add.classList.add('hide');
            }
            else if (add.classList.contains('hide')) {
                buttonName = 'op3';
                add = document.getElementById(buttonName);
                add.classList.add('hide');
            }
        }
        google.charts.load('current', { 'packages': ['corechart'] });

        firebase.database().ref('users/' + 'totalCount/').on('value', function (snapshot) {
            postVal = snapshot.val();
        });

        postVal = JSON.stringify(postVal);
        postVal = parseInt(postVal);
        console.log(postVal);

        function enterPosts() {
            if (postVal != NaN) {
                for (let index = 0; index <= postVal; index++) {
                    var testRef = firebase.database().ref('totalPosts/' + index + "/" + 'usersClicked/');
                    testRef.on('value', function (snapshot) {
                        if (!snapshot.hasChild(localStorage.getItem('idCurrent') + '/')) {
                            createCard(postVal - index);
                        }
                    });
                }
                console.log('now');
            }
        }

        const buttonPost = document.getElementById('buttonPost');
        buttonPost.addEventListener('click', e => {
            createCard(postVal);
        });

        console.log("Start Count");

        function checkRun() {
            if (postVal >= 0) {
                enterPosts();
                initializeOptions('1', 0);
                console.log('checked');
            } else {
                window.setTimeout(checkRun, 100);
            }
        }

        function returnQ(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'content');
            testRef.on('value', function (snapshot) {
                element.innerText = JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element);
                console.log(element.innerText)
            });
        }

        function returnOp1(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'op1/' + 'text');
            testRef.on('value', function (snapshot) {
                element.innerText = JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element);
                console.log(element.innerText)
            });
        }

        function returnOp2(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'op2/' + 'text');
            testRef.on('value', function (snapshot) {
                let x =
                    element.innerText = JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element);
                console.log(element.innerText)
            });
        }

        function returnOp3(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'op3/' + 'text');
            testRef.on('value', function (snapshot) {
                element.innerText = JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element);
                console.log(element.innerText)
            });
        }

        function returnOp4(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'op4/' + 'text');
            testRef.on('value', function (snapshot) {
                element.innerText = JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element.onclick)
                console.log(element);
                console.log(element.innerText)
            });
        }

        function returnBy(id, element) {
            var testRef = firebase.database().ref('totalPosts/' + id + '/' + 'email');
            testRef.on('value', function (snapshot) {
                element.innerText = 'By: ' + JSON.stringify(snapshot.val()).slice(1, -1);
                console.log(element);
                console.log(element.innerText)
            });
        }

        var modal = document.getElementById("myModal");
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                modal.style.opacity = 0;
            }
        }

        function createCard(cardId) {
            var spacer = document.createElement('div');
            spacer.setAttribute('class', 'spacer-main');
            var center = document.createElement("center");
            spacer.appendChild(center);
            var postbox = document.createElement('div');
            center.appendChild(postbox);
            postbox.setAttribute('class', 'postBox');
            postbox.setAttribute('style', 'text-align: center;');
            var header = document.createElement('h1');
            returnQ(cardId, header);
            header.setAttribute('class', 'optionTitle')
            postbox.appendChild(header);
            var div = document.createElement('div');
            div.setAttribute('style', 'text-align: center;')
            postbox.appendChild(div);
            var br1 = document.createElement('br');
            postbox.appendChild(br1);

            var opbtn1 = document.createElement('button');
            opbtn1.setAttribute('class', 'buttonMain rounded');
            opbtn1.setAttribute('style', 'display: inline-block;');
            opbtn1.setAttribute('id', '1');
            opbtn1.onclick = function () { changeColor(opbtn1) };
            div.appendChild(opbtn1);
            var p1 = document.createElement('p');
            p1.setAttribute('class', 'optionText');

            div.appendChild(p1);
            var br2 = document.createElement('br');
            div.appendChild(br2);

            var opbtn2 = document.createElement('button');
            opbtn2.setAttribute('class', 'buttonMain rounded');
            opbtn2.setAttribute('style', 'display: inline-block;');
            opbtn2.setAttribute('id', '2');
            opbtn2.onclick = function () { changeColor(opbtn2) };
            div.appendChild(opbtn2);
            var p2 = document.createElement('p');
            p2.setAttribute('class', 'optionText');
            div.appendChild(p2);
            var br3 = document.createElement('br');
            div.appendChild(br3);

            var opbtn3 = document.createElement('button');
            opbtn3.setAttribute('class', 'buttonMain rounded');
            opbtn3.setAttribute('style', 'display: inline-block;');
            opbtn3.setAttribute('id', '3');
            opbtn3.onclick = function () { changeColor(opbtn3) };
            div.appendChild(opbtn3);
            var p3 = document.createElement('p');
            p3.setAttribute('class', 'optionText');
            div.appendChild(p3);
            var br4 = document.createElement('br');
            div.appendChild(br4);

            var opbtn4 = document.createElement('button');
            opbtn4.setAttribute('class', 'buttonMain rounded');
            opbtn4.setAttribute('style', 'display: inline-block;');
            opbtn4.setAttribute('id', '4');
            opbtn4.onclick = function () { changeColor(opbtn4) };
            div.appendChild(opbtn4);
            var p4 = document.createElement('p');
            p4.setAttribute('class', 'optionText');
            div.appendChild(p4);
            var br5 = document.createElement('br');
            div.appendChild(br5);

            var submitBtn = document.createElement('button');
            submitBtn.setAttribute('class', 'buttonMain submitPoll');
            submitBtn.innerHTML = "Submit";
            submitBtn.onclick = function () { submitPoll(submitBtn, cardId) };
            div.appendChild(submitBtn);

            returnOp1(cardId, p1);
            returnOp2(cardId, p2);
            returnOp3(cardId, p3);
            returnOp4(cardId, p4);

            document.body.appendChild(spacer);
        }
        function submitPoll(x, id) {
            var parent = x.parentNode;
            var children = parent.children;
            for (let index = 0; index < children.length; index++) {
                var element = children[index];
                if (children[index].classList.contains('opColour')) {
                    if (children[index].id == '1') {
                        optionButtonClick('1', id, parent.parentNode.parentNode);
                    }
                    else if (children[index].id == '2') {
                        optionButtonClick('2', id, parent.parentNode.parentNode);
                    }
                    else if (children[index].id == '3') {
                        optionButtonClick('3', id, parent.parentNode.parentNode);
                    }
                    if (children[index].id == '4') {
                        optionButtonClick('4', id, parent.parentNode.parentNode);
                    }
                }
            }

            
            console.log(val1);
        }

        function changeColor(x) {
            x.classList.add("opColour");
            main = x.parentNode;
            parent = main.children;
            for (let index = 0; index < parent.length; index++) {
                if (parent[index] != x && parent[index].classList.contains('opColour')) {
                    parent[index].classList.remove("opColour");
                }
            }
        }

        function drawChart(op1, op2, op3, op4) {
            var data = google.visualization.arrayToDataTable([
                ['Option', 'Count'],
                ['Option 1', op1],
                ['Option 2', op2],
                ['Option 3', op3],
                ['Option 4', op4],
            ]);

            // Optional; add a title and set the width and height of the chart
            var options = { backgroundColor: 'transparent', 'title': 'Options', 'width': 400, 'height': 250 };
            var chart = new google.visualization.PieChart(document.getElementById('piechart'));
            chart.draw(data, options);
        }

        function drawChart2(op1, op2, op3, op4, el) {
            var data = google.visualization.arrayToDataTable([
                ['Task', 'Hours per Day'],
                ['Option 1', op1],
                ['Option 2', op2],
                ['Option 3', op3],
                ['Optiom 4', op4],
            ]);

            // Optional; add a title and set the width and height of the chart
            var options = { backgroundColor: 'transparent', 'title': 'Options', 'width': 400, 'height': 250 };
            var chart = new google.visualization.PieChart(el);
            chart.draw(data, options);
        }

        // option logic
        let val1;
        let val2;
        let val3;
        let val4;

        function showGraph() {
            google.charts.setOnLoadCallback(drawChart(val1, val2, val3, val4));
        }

        function optionButtonClick(opNum, id, element) {
            firebase.database().ref('totalPosts/' + id + '/' + 'op1/' + 'count/').once('value', function (snapshot) {
                val1 = snapshot.val();
                console.log(val1);
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op2/' + 'count/').once('value', function (snapshot) {
                val2 = snapshot.val();
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op3/' + 'count/').once('value', function (snapshot) {
                val3 = snapshot.val();
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op4/' + 'count/').once('value', function (snapshot) {
                val4 = snapshot.val();
            });
            let refSnapshot;
            let notclicked;
            // check if user has already clicked the button
            firebase.database().ref('totalPosts/' + id + '/' + 'usersClicked/').on('value', function (snapshot) {
                refSnapshot = snapshot;

                if (!snapshot.hasChild(localStorage.getItem('idCurrent'))) {
                    notclicked = true;
                    console.log('snap')
                }
                else {
                    notclicked = false;
                    console.log('snaps')
                }
            });

            if (notclicked) {
                val1 = 0;
                val2 = 0;
                val3 = 0;
                val4 = 0;
                console.log('not clicked');
                firebase.database().ref('totalPosts/' + id + '/' + 'usersClicked/' + localStorage.getItem('idCurrent') + '/').set({
                    in: 'true',
                });
                // ('totalPosts/' + id + '/' + 'op1/' + 'count')

                val1 = parseInt(val1);
                val2 = parseInt(val2);
                val3 = parseInt(val3);
                val4 = parseInt(val4);

                let postUserID;
                firebase.database().ref('totalPosts/' + id + '/' + 'id').on('value', function (snapshot) {
                    postUserID = snapshot.val().slice(-1, 1);
                    console.log(postUserID)
                });

                if (opNum == '1') {
                    console.log(parseInt(val1) + ' Val1 is')

                    firebase.database().ref('totalPosts/' + id + '/' + 'op1/').update({
                        'count': val1 + 1,
                    });
                    firebase.database().ref('userIDs/' + postUserID + '/' + id + '/' + 'op1/').update({
                        'count': val1 + 1
                    });
                    alert('Submitted');
                }
                else if (opNum == '2') {

                    firebase.database().ref('totalPosts/' + id + '/' + 'op2/').update({
                        'count': val2 + 1
                    });
                    firebase.database().ref('userIDs/' + postUserID + '/' + id + '/' + 'op2/').update({
                        'count': val2 + 1
                    });
                    alert('Submitted');
                }
                else if (opNum == '3') {
                    firebase.database().ref('totalPosts/' + id + '/' + 'op3/').update({
                        'count': val3 + 1
                    });
                    firebase.database().ref('userIDs/' + postUserID + '/' + id + '/' + 'op3/').update({
                        'count': val3 + 1
                    });
                    alert('Submitted');
                }
                else if (opNum == '4' && val4 != NaN) {
                    firebase.database().ref('totalPosts/' + id + '/' + 'op4/').update({
                        'count': val4 + 1
                    });
                    firebase.database().ref('userIDs/' + postUserID + '/' + id + '/' + 'op4/').update({
                        'count': val4 + 1
                    });
                    alert('Submitted');
                }
            }
            else {
                console.log('clicked');
                console.log(id);
            }
        }

        function initializeOptions(opNum, id) {
            let refSnapshot;
            let notclicked;
            // check if user has already clicked the button
            firebase.database().ref('totalPosts/' + id + '/' + 'usersClicked/').on('value', function (snapshot) {
                refSnapshot = snapshot;

                if (!snapshot.hasChild(localStorage.getItem('idCurrent'))) {
                    notclicked = true;
                    console.log('snap')
                }
                else {
                    notclicked = false;
                    console.log('snaps')
                }

                console.log('ran notcliked');

            });


            // ('totalPosts/' + id + '/' + 'op1/' + 'count')
            firebase.database().ref('totalPosts/' + id + '/' + 'op1/' + 'count/').once('value', function (snapshot) {
                val1 = snapshot.val();
                console.log(val1);
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op2/' + 'count/').once('value', function (snapshot) {
                val2 = snapshot.val();
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op3/' + 'count/').once('value', function (snapshot) {
                val3 = snapshot.val();
            });
            firebase.database().ref('totalPosts/' + id + '/' + 'op4/' + 'count/').once('value', function (snapshot) {
                val4 = snapshot.val();
            });

            val1 = parseInt(val1);
            val2 = parseInt(val2);
            val3 = parseInt(val3);
            val4 = parseInt(val4);


            if (opNum == '1') {
                console.log(parseInt(val1) + ' Val1 is')
                firebase.database().ref('totalPosts/' + id + '/' + 'op1/').update({
                    'count': val1
                });
            }
            else if (opNum == '2') {
                firebase.database().ref('totalPosts/' + id + '/' + 'op2/').update({
                    'count': val2
                });
            }
            else if (opNum == '3') {
                firebase.database().ref('totalPosts/' + id + '/' + 'op3/').update({
                    'count': val3
                });
            }
            else if (opNum == '4' && val4 != NaN) {
                firebase.database().ref('totalPosts/' + id + '/' + 'op4/').update({
                    'count': val4
                });
            }
        }

    </script>

</body>

</html>